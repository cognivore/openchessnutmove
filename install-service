#!/usr/bin/env bash
# Install Chessnut Move Server as a macOS LaunchAgent service
# Usage: ./install-service [install|uninstall|status|logs|restart]

set -euo pipefail

SERVICE_NAME="com.chessnut.move"
PLIST_FILE="$HOME/Library/LaunchAgents/${SERVICE_NAME}.plist"

PROJECT_DIR="$(cd "$(dirname "$0")" && pwd)"
LOG_DIR="$HOME/.chessnut/logs"

# Shared Caddy location
CADDY_HOME="$HOME/Caddy"
CADDY_SITES_DIR="$CADDY_HOME/sites"
MY_CADDY_SITE="$CADDY_SITES_DIR/chessnut.Caddyfile"

# Server config
SERVER_PORT=8675

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
header() { echo -e "${BLUE}=== $1 ===${NC}"; }

check_prerequisites() {
    if ! command -v nix &>/dev/null; then
        error "nix not found. Please install Nix first."
        exit 1
    fi

    if [[ ! -d "$PROJECT_DIR/.venv" ]]; then
        warn ".venv not found. Creating it now..."
        (cd "$PROJECT_DIR" && nix develop --command bash -c "python -m venv .venv && source .venv/bin/activate && pip install -q -r requirements.txt")
        info "Virtual environment created."
    fi

    if [[ ! -f "$PROJECT_DIR/flake.nix" ]]; then
        error "flake.nix not found in $PROJECT_DIR"
        exit 1
    fi
}

generate_caddy_site() {
    mkdir -p "$CADDY_SITES_DIR"
    
    cat > "$MY_CADDY_SITE" << EOF
# Chessnut Move Server - http://chessnut.localhost
http://chessnut.localhost {
	reverse_proxy localhost:${SERVER_PORT}
}
EOF
    info "Generated Caddy site config at $MY_CADDY_SITE"
}

reload_caddy() {
    if [[ -d "$CADDY_HOME" ]]; then
        info "Reloading Caddy configuration..."
        (cd "$CADDY_HOME" && nix develop --command caddy reload --config Caddyfile 2>/dev/null) || \
            warn "Could not reload Caddy. You may need to run: cd ~/Caddy && caddy-reload"
    fi
}

generate_plist() {
    mkdir -p "$LOG_DIR"
    mkdir -p "$(dirname "$PLIST_FILE")"

    cat > "$PLIST_FILE" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>${SERVICE_NAME}</string>

    <key>ProgramArguments</key>
    <array>
        <string>/nix/var/nix/profiles/default/bin/nix</string>
        <string>develop</string>
        <string>${PROJECT_DIR}</string>
        <string>--command</string>
        <string>bash</string>
        <string>-c</string>
        <string>source .venv/bin/activate &amp;&amp; exec python -m chessnut_move_stack.server</string>
    </array>

    <key>WorkingDirectory</key>
    <string>${PROJECT_DIR}</string>

    <key>EnvironmentVariables</key>
    <dict>
        <key>HOME</key>
        <string>${HOME}</string>
        <key>PATH</key>
        <string>/nix/var/nix/profiles/default/bin:/usr/bin:/bin:/usr/sbin:/sbin</string>
        <key>PYTHONPATH</key>
        <string>${PROJECT_DIR}</string>
        <key>CHESSNUT_HOST</key>
        <string>127.0.0.1</string>
        <key>CHESSNUT_PORT</key>
        <string>${SERVER_PORT}</string>
        <key>CHESSNUT_AUTO_CONNECT</key>
        <string>1</string>
    </dict>

    <key>RunAtLoad</key>
    <true/>

    <key>KeepAlive</key>
    <dict>
        <key>SuccessfulExit</key>
        <false/>
        <key>Crashed</key>
        <true/>
    </dict>

    <key>ThrottleInterval</key>
    <integer>10</integer>

    <key>StandardOutPath</key>
    <string>${LOG_DIR}/server.stdout.log</string>

    <key>StandardErrorPath</key>
    <string>${LOG_DIR}/server.stderr.log</string>

    <key>ProcessType</key>
    <string>Background</string>
</dict>
</plist>
EOF
    info "Generated plist at $PLIST_FILE"
}

do_install() {
    header "Installing Chessnut Move Server"
    check_prerequisites

    # Unload if already running
    if launchctl list 2>/dev/null | grep -q "$SERVICE_NAME"; then
        warn "Service already loaded. Unloading first..."
        launchctl unload "$PLIST_FILE" 2>/dev/null || true
    fi

    # Generate configs
    generate_plist
    generate_caddy_site

    # Load service
    info "Loading service..."
    launchctl load "$PLIST_FILE"

    # Reload Caddy
    reload_caddy

    sleep 2
    echo ""
    do_status
}

do_uninstall() {
    header "Uninstalling Chessnut Move Server"

    if [[ -f "$PLIST_FILE" ]]; then
        launchctl unload "$PLIST_FILE" 2>/dev/null || true
        rm -f "$PLIST_FILE"
        info "Removed LaunchAgent plist"
    else
        warn "Service plist not found"
    fi

    if [[ -f "$MY_CADDY_SITE" ]]; then
        rm -f "$MY_CADDY_SITE"
        info "Removed Caddy site config"
        reload_caddy
    fi

    info "Uninstall complete."
    info "Log files remain at: $LOG_DIR"
}

do_status() {
    header "Service Status"
    
    local svc_info
    svc_info=$(launchctl list 2>/dev/null | grep "$SERVICE_NAME" || true)
    
    if [[ -n "$svc_info" ]]; then
        local pid=$(echo "$svc_info" | awk '{print $1}')
        if [[ "$pid" != "-" && "$pid" =~ ^[0-9]+$ ]]; then
            echo -e "  Server: ${GREEN}Running${NC} (PID: $pid)"
        else
            echo -e "  Server: ${YELLOW}Loaded but not running${NC}"
        fi
    else
        echo -e "  Server: ${RED}Not installed${NC}"
    fi

    echo ""
    header "Health Check"
    
    if curl -s "http://localhost:${SERVER_PORT}/health" 2>/dev/null | grep -q "ok"; then
        echo -e "  API (localhost:${SERVER_PORT}): ${GREEN}Healthy${NC}"
    else
        echo -e "  API (localhost:${SERVER_PORT}): ${RED}Not responding${NC}"
    fi

    if curl -s "http://chessnut.localhost/health" 2>/dev/null | grep -q "ok"; then
        echo -e "  Caddy proxy: ${GREEN}Working${NC}"
    else
        echo -e "  Caddy proxy: ${YELLOW}Not working${NC} (is Caddy running?)"
    fi

    # Check driver/board status
    local driver_status
    driver_status=$(curl -s "http://localhost:${SERVER_PORT}/api/driver/status" 2>/dev/null || echo "{}")
    
    if echo "$driver_status" | grep -q '"connected": true'; then
        echo -e "  Board: ${GREEN}Connected${NC}"
    elif echo "$driver_status" | grep -q '"enabled": true'; then
        echo -e "  Board: ${YELLOW}Enabled but not connected${NC}"
    elif echo "$driver_status" | grep -q '"enabled": false'; then
        echo -e "  Board: ${BLUE}Driver disabled${NC}"
    else
        echo -e "  Board: ${RED}Unknown${NC}"
    fi

    echo ""
    header "URLs"
    echo -e "  App:    ${GREEN}http://chessnut.localhost${NC}"
    echo "  Direct: http://localhost:${SERVER_PORT}"
    echo "  API:    http://chessnut.localhost/api/state"

    echo ""
    header "Logs"
    echo "  stdout: $LOG_DIR/server.stdout.log"
    echo "  stderr: $LOG_DIR/server.stderr.log"

    echo ""
    header "Commands"
    echo "  Connect to board:    curl -X POST http://chessnut.localhost/api/driver/connect"
    echo "  Disconnect:          curl -X POST http://chessnut.localhost/api/driver/disconnect"
    echo "  Toggle autoconnect:  curl -X POST http://chessnut.localhost/api/driver/autoconnect -d '{\"enabled\":true}'"
    echo "  Set FEN:             curl -X POST http://chessnut.localhost/api/state/fen -d '{\"fen\":\"...\"}'"
}

do_logs() {
    local lines="${2:-50}"
    
    header "Server Logs (last $lines lines)"
    
    if [[ -f "$LOG_DIR/server.stderr.log" ]]; then
        tail -"$lines" "$LOG_DIR/server.stderr.log"
    else
        echo "  (no logs yet)"
    fi
}

do_restart() {
    header "Restarting Chessnut Move Server"

    if [[ -f "$PLIST_FILE" ]]; then
        launchctl unload "$PLIST_FILE" 2>/dev/null || true
        sleep 1
        launchctl load "$PLIST_FILE"
        info "Service restarted"
        sleep 2
        do_status
    else
        error "Service not installed. Run: $0 install"
        exit 1
    fi
}

do_follow() {
    header "Following logs (Ctrl+C to stop)"
    tail -f "$LOG_DIR/server.stderr.log" "$LOG_DIR/server.stdout.log" 2>/dev/null || \
        error "No log files found. Is the service installed?"
}

# Main
case "${1:-help}" in
    install)
        do_install
        ;;
    uninstall|remove)
        do_uninstall
        ;;
    status)
        do_status
        ;;
    logs)
        do_logs "$@"
        ;;
    follow)
        do_follow
        ;;
    restart)
        do_restart
        ;;
    *)
        echo "Chessnut Move Service Manager"
        echo ""
        echo "Usage: $0 <command>"
        echo ""
        echo "Commands:"
        echo "  install    Install server as LaunchAgent + register with Caddy"
        echo "  uninstall  Stop and remove LaunchAgent"
        echo "  status     Show service status and health check"
        echo "  restart    Restart the server"
        echo "  logs [N]   Show last N lines of logs (default: 50)"
        echo "  follow     Tail logs continuously"
        echo ""
        echo "The service will:"
        echo "  - Start automatically on login"
        echo "  - Restart if it crashes"
        echo "  - Auto-connect to Chessnut Move board via Bluetooth"
        echo "  - Register with shared Caddy at ~/Caddy"
        echo ""
        echo -e "URL: ${GREEN}http://chessnut.localhost${NC}"
        echo ""
        echo "Log files: $LOG_DIR/"
        ;;
esac
